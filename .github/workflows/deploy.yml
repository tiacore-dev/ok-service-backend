name: CI/CD to Server

on:
  push:
    branches: [ master, dev, stage ]

env:
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/ok-service-backend

jobs:
  build-test-push:
    runs-on: ubuntu-latest
    if: github.ref_name == 'master' || github.ref_name == 'dev' || github.ref_name == 'stage'

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          install: true

      - name: Generate fake VAPID keys
        run: |
          openssl ecparam -genkey -name prime256v1 -noout -out vapid_private_key.pem
          openssl ec -in vapid_private_key.pem -pubout -out vapid_public_key.pem

      - name: Create test .env
        run: |
          echo "JWT_SECRET_KEY=testing_key" > .env.test
          echo "SECRET_KEY=another_test_key" >> .env.test
          echo "TEST_DATABASE_URL=postgresql://test:test@172.17.0.1:5432/test_db" >> .env.test

      - name: Build test image & run tests
        run: |
          docker buildx build \
            --target test \
            --cache-from=type=registry,ref=${{ env.IMAGE_NAME }}:buildcache \
            --cache-to=type=registry,ref=${{ env.IMAGE_NAME }}:buildcache,mode=max \
            --load \
            -t ok-service-backend-test .

          docker run \
            --rm \
            --env-file .env.test \
            ok-service-backend-test \
            pytest --maxfail=3 --disable-warnings

      - name: Build and Push prod image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          target: prod
          tags: ${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache,mode=max

      - name: Clean up VAPID keys
        run: rm -f vapid_*.pem

      - name: Clean up .env.test
        run: rm -f .env.test



  deploy:
    runs-on: ubuntu-latest
    needs: build-test-push

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ github.ref_name == 'master' && secrets.SSH_PRIVATE_KEY_MASTER || github.ref_name == 'dev' && secrets.SSH_PRIVATE_KEY_DEV || secrets.SSH_PRIVATE_KEY_STAGE }}

      - name: Set env vars per branch
        run: |
          if [[ "${{ github.ref_name }}" == "master" ]]; then
            echo "DEPLOY_PATH=apps/ok-service-backend" >> $GITHUB_ENV
            echo "SERVER_IP=${{ secrets.SERVER_IP_MASTER }}" >> $GITHUB_ENV
            echo "SSH_USER=${{ secrets.SSH_USER_MASTER }}" >> $GITHUB_ENV
          elif [[ "${{ github.ref_name }}" == "dev" ]]; then
            echo "DEPLOY_PATH=apps/ok-service-backend-dev" >> $GITHUB_ENV
            echo "SERVER_IP=${{ secrets.SERVER_IP_DEV }}" >> $GITHUB_ENV
            echo "SSH_USER=${{ secrets.SSH_USER_DEV }}" >> $GITHUB_ENV
          else
            echo "DEPLOY_PATH=apps/ok-service-backend-stage" >> $GITHUB_ENV
            echo "SERVER_IP=${{ secrets.SERVER_IP_STAGE }}" >> $GITHUB_ENV
            echo "SSH_USER=${{ secrets.SSH_USER_STAGE }}" >> $GITHUB_ENV
          fi
          echo "DEPLOY_TAG=${{ github.sha }}" >> $GITHUB_ENV

      - name: Deploy to server (pull + update env)
        run: |
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SERVER_IP <<EOF
            set -e
            cd $DEPLOY_PATH
            echo "–í–µ—Ç–∫–∞: ${GITHUB_REF##*/}"

            git pull origin ${GITHUB_REF##*/}
            
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/ok-service-backend:${{ github.sha }}

            if [ ! -f .env ]; then touch .env; fi
            grep -q "^TAG=" .env && sed -i "s/^TAG=.*/TAG=${{ github.sha }}/" .env || echo "TAG=${{ github.sha }}" >> .env
          EOF


      - name: Run Alembic migrations (via exec)
        run: |
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SERVER_IP <<EOF
            set -e
            cd $DEPLOY_PATH
            docker compose -f docker-compose.app.yaml pull web
            docker compose -f docker-compose.app.yaml run --rm web alembic upgrade head 
          EOF


      - name: Restart backend container
        run: |
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SERVER_IP <<EOF
            set -e
            cd $DEPLOY_PATH
            docker compose -f docker-compose.app.yaml up -d --force-recreate web
            docker image prune -f > /dev/null
          EOF



  notify:
    name: üì¨ Notifications
    runs-on: ubuntu-latest
    needs: [build-test-push, deploy]
    if: always()
    steps:
      - name: üì¨ Telegram Notification
        run: |
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          REF_NAME="${{ github.ref_name }}"
          SHA="${{ github.sha }}"
          AUTHOR="${{ github.event.head_commit.author.name }}"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          DEPLOY_STATUS="${{ needs.deploy.result }}"

          if [ "$DEPLOY_STATUS" != "success" ]; then
            STATUS="üõë *–û—à–∏–±–∫–∞ –¥–µ–ø–ª–æ—è*"
            EXTRA_LINK="\n\n[üîç –û—Ç–∫—Ä—ã—Ç—å GitHub Actions]($RUN_URL)"
          else
            STATUS="‚úÖ –î–µ–ø–ª–æ–π *—É—Å–ø–µ—à–µ–Ω*"
            EXTRA_LINK=""
          fi

          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          THREAD_ID="${{ secrets.TELEGRAM_THREAD_ID }}"

          TEXT="${STATUS}

          üì¶ *–í–µ—Ç–∫–∞:* \`$REF_NAME\`
          üîñ *–¢–µ–≥:* \`$SHA\`
          üë§ *–ê–≤—Ç–æ—Ä –¥–µ–ø–ª–æ—è:* [$AUTHOR](https://github.com/$AUTHOR)
          üìù *–ö–æ–º–º–∏—Ç:* $COMMIT_MESSAGE${EXTRA_LINK}"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="$CHAT_ID" \
            -d message_thread_id=$THREAD_ID \
            -d parse_mode=Markdown \
            -d "text=$TEXT"

      - name: üì• Mattermost & OpenProject notification
        # —á—Ç–æ–±—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –ª–æ–º–∞–ª–æ –ø–∞–π–ø–ª–∞–π–Ω, –Ω–æ job –≤—Å—ë —Ä–∞–≤–Ω–æ –≤—ã–ø–æ–ª–Ω—è–ª—Å—è
        continue-on-error: true
        run: |
          set -euo pipefail

          MATTERMOST_WEBHOOK_URL="${{ secrets.MATTERMOST_WEBHOOK_URL }}"
          OPENPROJECT_URL="${{ secrets.OPENPROJECT_URL }}"
          OPENPROJECT_API_TOKEN="${{ secrets.OPENPROJECT_API_TOKEN }}"
          SERVICE_NAME="ok-service-backend"

          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          REF_NAME="${{ github.ref_name }}"
          SHA="${{ github.sha }}"
          SHORT_SHA="${SHA::8}"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          REPO_URL="https://github.com/${{ github.repository }}"
          DEPLOY_STATUS="${{ needs.deploy.result }}"

          # --- 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ –ø–æ –≤–µ—Ç–∫–µ (–∫–∞–∫ –≤ GitLab-–ø—Ä–∏–º–µ—Ä–µ)
          case "${REF_NAME}" in
            dev)    ENV_NAME="dev" ;;
            stage)  ENV_NAME="stage" ;;
            master) ENV_NAME="prod" ;;
            *)      ENV_NAME="${REF_NAME}" ;;
          esac

          # --- 2. –î–æ—Å—Ç–∞—ë–º ID –∑–∞–¥–∞—á –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–º–º–∏—Ç–∞ (OP#123)
          extract_op_ids() {
            printf '%s\n' "${COMMIT_MESSAGE}" \
              | grep -oE 'OP#[0-9]+' \
              | sed 's/OP#//g' \
              | sort -u
          }

          OP_IDS="$(extract_op_ids || true)"

          TASKS_BLOCK=""
          if [ -n "${OP_IDS:-}" ]; then
            TASKS_BLOCK="**Tasks (OpenProject):**"
            for ID in ${OP_IDS}; do
              URL="${OPENPROJECT_URL%/}/work_packages/${ID}"
              TASKS_BLOCK="${TASKS_BLOCK}
              ‚Ä¢ [#${ID}](${URL})"
            done
          else
            TASKS_BLOCK="_No linked tasks (no OP#ID in commit message)_"
          fi

          # --- 3. –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ —Å—Ç–∞—Ç—É—Å—É –¥–µ–ø–ª–æ—è (–ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ —Å DEPLOY_STACK_STATUS)
          STATUS="${DEPLOY_STATUS}"

          case "${STATUS}" in
            success)  HEAD="‚úÖ Deploy successful" ;;
            failure)  HEAD="üõë Deploy failed" ;;
            cancelled) HEAD="üö´ Deploy canceled" ;;
            skipped)  HEAD="‚è≠ Deploy skipped" ;;
            *)        HEAD="‚ÑπÔ∏è Deploy status: ${STATUS}" ;;
          esac

          # --- 4. –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è Mattermost
          TEXT=$(cat <<EOF
            ${HEAD}

            **Service:** \`${SERVICE_NAME}\`
            **Env:** \`${ENV_NAME}\`
            **Branch:** \`${REF_NAME}\`
            **Commit:** \`${SHORT_SHA}\`

            ${TASKS_BLOCK}

            [üîó Open pipeline](${RUN_URL})
            [üì¶ Repository](${REPO_URL})
            EOF
          )

          # --- 5. –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Mattermost
          if [ -n "${MATTERMOST_WEBHOOK_URL:-}" ]; then
            # jq –æ–±—ã—á–Ω–æ –µ—Å—Ç—å –Ω–∞ ubuntu-latest, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å:
            if ! command -v jq >/dev/null 2>&1; then
              sudo apt-get update -y >/dev/null
              sudo apt-get install -y jq >/dev/null
            fi

            payload=$(jq -n --arg text "$TEXT" '{text: $text, username: "github-actions", icon_emoji: ":rocket:"}')

            curl -sS -X POST \
              -H "Content-Type: application/json" \
              -d "$payload" \
              "${MATTERMOST_WEBHOOK_URL}"
          else
            echo "No MATTERMOST_WEBHOOK_URL, skip Mattermost notification"
          fi

          # --- 6. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ OpenProject
          if [ -n "${OP_IDS:-}" ] && [ -n "${OPENPROJECT_API_TOKEN:-}" ] && [ -n "${OPENPROJECT_URL:-}" ]; then
            if ! command -v jq >/dev/null 2>&1; then
              sudo apt-get update -y >/dev/null
              sudo apt-get install -y jq >/dev/null
            fi

            COMMENT="Deployed to ${ENV_NAME} via GitHub Actions run ${RUN_URL}"

            for ID in ${OP_IDS}; do
              echo "Post comment to OP#${ID}"
              curl -sS -X POST \
                -u "apikey:${OPENPROJECT_API_TOKEN}" \
                -H "Content-Type: application/json" \
                "${OPENPROJECT_URL%/}/api/v3/work_packages/${ID}/activities" \
                -d "$(jq -n --arg c "$COMMENT" '{comment: {raw: $c}}')" \
                || echo "Failed to comment on ${ID}"
            done
          else
            echo "No OP_IDS or OPENPROJECT credentials, skip OpenProject comments"
          fi
