name: CI/CD to Server

on:
  push:
    branches: [ master, dev, stage ]

env:
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/ok-service-backend

jobs:
  build-test-push:
    runs-on: ubuntu-latest
    if: github.ref_name == 'master' || github.ref_name == 'dev' || github.ref_name == 'stage'

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker Image
        run: docker build -t $IMAGE_NAME:${{ github.sha }} .

      - name: Generate fake VAPID keys
        run: |
          openssl ecparam -genkey -name prime256v1 -noout -out vapid_private_key.pem
          openssl ec -in vapid_private_key.pem -pubout -out vapid_public_key.pem

      - name: Create test .env
        run: |
          echo "JWT_SECRET_KEY=testing_key" > .env.test
          echo "SECRET_KEY=another_test_key" >> .env.test
          echo "TEST_DATABASE_URL=postgresql://test:test@172.17.0.1:5432/test_db" >> .env.test


      - name: Run Tests inside Docker
        run: |
          docker run --rm \
            --env-file .env.test \
            -v ${{ github.workspace }}/vapid_private_key.pem:/app/vapid_private_key.pem \
            -v ${{ github.workspace }}/vapid_public_key.pem:/app/vapid_public_key.pem \
            $IMAGE_NAME:${{ github.sha }} \
            pytest --maxfail=3 --disable-warnings

      - name: Push Image
        run: docker push $IMAGE_NAME:${{ github.sha }}

      - name: Clean up VAPID keys
        run: rm -f vapid_*.pem

      - name: Clean up .env.test
        run: rm -f .env.test



  deploy:
    runs-on: ubuntu-latest
    needs: build-test-push

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ github.ref_name == 'master' && secrets.SSH_PRIVATE_KEY_MASTER || github.ref_name == 'dev' && secrets.SSH_PRIVATE_KEY_DEV || secrets.SSH_PRIVATE_KEY_STAGE }}


      - name: Set env vars per branch
        run: |
          if [[ "${{ github.ref_name }}" == "master" ]]; then
            echo "DEPLOY_PATH=apps/ok-service-backend" >> $GITHUB_ENV
            echo "SERVER_IP=${{ secrets.SERVER_IP_MASTER }}" >> $GITHUB_ENV
            echo "SSH_USER=${{ secrets.SSH_USER_MASTER }}" >> $GITHUB_ENV
          elif [[ "${{ github.ref_name }}" == "dev" ]]; then
            echo "DEPLOY_PATH=apps/ok-service-backend-dev" >> $GITHUB_ENV
            echo "SERVER_IP=${{ secrets.SERVER_IP_DEV }}" >> $GITHUB_ENV
            echo "SSH_USER=${{ secrets.SSH_USER_DEV }}" >> $GITHUB_ENV
          else
            echo "DEPLOY_PATH=apps/ok-service-backend-stage" >> $GITHUB_ENV
            echo "SERVER_IP=${{ secrets.SERVER_IP_STAGE }}" >> $GITHUB_ENV
            echo "SSH_USER=${{ secrets.SSH_USER_STAGE }}" >> $GITHUB_ENV
          fi
          echo "DEPLOY_TAG=${{ github.sha }}" >> $GITHUB_ENV

      - name: Start containers (DB + web in background)
        run: |
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SERVER_IP "
            cd $DEPLOY_PATH &&
            git pull origin ${GITHUB_REF##*/} && \
            docker compose -f docker-compose.app.yaml up -d --build --remove-orphans web db && \
            docker image prune -f
          "

      - name: Run Alembic migrations
        run: |
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SERVER_IP "
            cd $DEPLOY_PATH &&
            docker compose -f docker-compose.app.yaml exec web alembic upgrade head
          "




  notify:
    name: üì¨ Telegram Notify
    runs-on: ubuntu-latest
    needs: [build-test-push, deploy]
    if: always()
    steps:
      - name: üì¨ Telegram Notification
        run: |
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          REF_NAME="${{ github.ref_name }}"
          SHA="${{ github.sha }}"
          AUTHOR="${{ github.event.head_commit.author.name }}"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          DEPLOY_STATUS="${{ needs.deploy.result }}"

          if [ "$DEPLOY_STATUS" != "success" ]; then
            STATUS="üõë *–û—à–∏–±–∫–∞ –¥–µ–ø–ª–æ—è*"
            EXTRA_LINK="\n\n[üîç –û—Ç–∫—Ä—ã—Ç—å GitHub Actions]($RUN_URL)"
          else
            STATUS="‚úÖ –î–µ–ø–ª–æ–π *—É—Å–ø–µ—à–µ–Ω*"
            EXTRA_LINK=""
          fi

          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"

          TEXT="${STATUS}

          üì¶ *–í–µ—Ç–∫–∞:* \`$REF_NAME\`
          üîñ *–¢–µ–≥:* \`$SHA\`
          üë§ *–ê–≤—Ç–æ—Ä –¥–µ–ø–ª–æ—è:* [$AUTHOR](https://github.com/$AUTHOR)
          üìù *–ö–æ–º–º–∏—Ç:* $COMMIT_MESSAGE${EXTRA_LINK}"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="$CHAT_ID" \
            -d parse_mode=Markdown \
            -d "text=$TEXT"